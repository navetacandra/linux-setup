#!/bin/sh
set -e

if [ "$(id -u)" -ne 0 ]; then
    echo "ERROR: Script ini harus dijalankan pertama kali sebagai root untuk setup user."
    exit 1
fi

echo ">>> [ROOT] Menyiapkan environment build..."
cat << 'EOF' > /etc/apk/repositories
http://dl-cdn.alpinelinux.org/alpine/v3.23/main
http://dl-cdn.alpinelinux.org/alpine/v3.23/community
EOF
apk update && apk upgrade
apk add abuild alpine-conf syslinux xorriso squashfs-tools grub mtools git python3 curl sudo bash

if ! id "builder" >/dev/null 2>&1; then
    echo ">>> [ROOT] Membuat user 'builder'..."
    adduser -D builder
    addgroup builder abuild
    adduser builder abuild
fi

echo ">>> [ROOT] Mengkonfigurasi sudoers..."
echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder
chmod 0440 /etc/sudoers.d/builder

# --- SCRIPT BUILDER DIMULAI DI SINI ---
cat << 'EOF' > /home/builder/run_build.sh
#!/bin/sh
set -e
export PROFILENAME=alpine-test

# --- 0. CLEANUP TOTAL ---
cd "$HOME"

echo ">>> Membersihkan sisa build sebelumnya..."
rm -rf "$HOME/packages"
rm -rf "$HOME/distfiles"
rm -rf "$HOME/.abuild"
rm -rf "$HOME/aports/community/menu-install"

# --- 1. PERSIAPAN SISTEM ---
echo ">>> Persiapan Sistem..."
mkdir -pv ~/tmp
export TMPDIR=~/tmp

# Setup Key (Paksa overwrite)
abuild-keygen -a -n

# Setup direktori output
mkdir -p "$HOME/distfiles"
mkdir -p "$HOME/packages"

# Config abuild
echo "SRCDEST=$HOME/distfiles" >> "$HOME/.abuild/abuild.conf"
echo "REPODEST=$HOME/packages" >> "$HOME/.abuild/abuild.conf"
echo "PACKAGER=\"Build User <dev@navetacandraa.my.id>\"" >> "$HOME/.abuild/abuild.conf"

# Copy public key ke /etc/apk/keys
if sudo -n true 2>/dev/null; then
    sudo cp "$HOME/.abuild/"*.rsa.pub /etc/apk/keys/
else
    echo ">>> Warning: Tidak bisa sudo, nanti key akan dicopy manual ke ISO."
fi

# Clone aports
if [ ! -d "$HOME/aports" ]; then
    git clone --depth=1 https://gitlab.alpinelinux.org/alpine/aports.git ~/aports
fi

# --- 2. BUILD PACKAGE ---
echo ">>> Memulai Build Package..."
mkdir -p ~/aports/community/menu-install
cd ~/aports/community/menu-install

cat << 'PKG' > APKBUILD
# Maintainer: Naveta Candra <dev@navetacandraa.my.id>
pkgname=menu-install
pkgver=1.0
pkgrel=0
pkgdesc="Custom Alpine Setup Script"
url="https://github.com/navetacandra/linux-setup"
arch="x86_64"
license="MIT"
depends="bash curl sudo"
source="https://raw.githubusercontent.com/navetacandra/linux-setup/refs/heads/main/alpine-setup"
builddir="$srcdir"
options="!check"

package() {
    install -Dm755 alpine-setup "$pkgdir/usr/bin/menu-install"
}
PKG

abuild checksum

echo ">>> Menjalankan abuild -r..."
abuild -r || true

# Cek manual apakah file .apk berhasil dibuat
APK_FILE=$(find "$HOME/packages" -name "menu-install-*.apk" | head -n 1)
if [ -z "$APK_FILE" ]; then
    echo "ERROR: Build gagal! File .apk tidak ditemukan."
    exit 1
else
    echo ">>> Build Sukses: $APK_FILE"
fi

# --- 3. FIX REPO INDEX (MANUAL) ---
echo ">>> Generating Repository Index..."

cd "$HOME/packages/community/x86_64" || cd "$HOME/packages/community/noarch" || { echo "ERROR: Folder package tidak ketemu!"; exit 1; }

rm -f APKINDEX.tar.gz

echo ">>> Running apk index..."
apk index --allow-untrusted -o APKINDEX.tar.gz *.apk || true

PRIV_KEY=$(find "$HOME/.abuild" -name "*.rsa" | head -n 1)
if [ -z "$PRIV_KEY" ]; then
    echo "ERROR: Private key tidak ditemukan di $HOME/.abuild/"
    exit 1
fi

echo ">>> Signing index using key: $PRIV_KEY"
abuild-sign -k "$PRIV_KEY" APKINDEX.tar.gz
echo ">>> Index generated and signed."

# --- 4. CONFIG PROFILE ISO ---
echo ">>> Configuring ISO Profile..."
TARGET_PROFILE="$HOME/aports/scripts/mkimg.$PROFILENAME.sh"

# PERBAIKAN DISINI: Hapus tanda kutip di 'PROF' menjadi PROF
cat << PROF > "$TARGET_PROFILE"
profile_$PROFILENAME() {
    profile_standard
    kernel_flavors="lts"
    kernel_cmdline="console=tty0 console=ttyS0,115200"
    syslinux_serial="0 115200"
    
    # Tambahkan package custom dan key public user
    # Variabel \$apks menggunakan backslash agar tidak diekspansi sekarang, tapi nanti oleh mkimage
    apks="\$apks bash menu-install openssl ca-certificates"

    local _k _a
    for _k in \$kernel_flavors; do
        apks="\$apks linux-\$_k"
        for _a in \$kernel_addons; do
            apks="\$apks \$_a-\$_k"
        done
    done
    apks="\$apks linux-firmware"
}
PROF

echo ">>> Menjalankan Python Web Server di port 8080..."
cd "$HOME/packages/community"
# Matikan server lama jika ada
pkill -f "http.server 8080" || true
python3 -m http.server 8080 &
HTTP_PID=$!
sleep 2 

# --- 5. BUILD ISO ---
echo ">>> Starting ISO Build..."
cd ~/aports/scripts
mkdir -p ~/iso

# Salin public key ke folder ISO
cp "$HOME/.abuild/"*.rsa.pub ~/iso/ || true

sh mkimage.sh \
  --tag edge \
  --outdir /iso \
  --arch x86_64 \
  --repository https://dl-cdn.alpinelinux.org/alpine/edge/main \
  --repository https://dl-cdn.alpinelinux.org/alpine/edge/community \
  --repository http://127.0.0.1:8080 \
  --profile "$PROFILENAME"

kill "$HTTP_PID" 2>/dev/null || true
echo "-------------------------------------------------------"
echo "Build Selesai!"
echo "Lokasi ISO: $(ls /iso/alpine-*.iso 2>/dev/null)"
echo "-------------------------------------------------------"
EOF
# --- SCRIPT BUILDER BERAKHIR DI SINI ---

chown builder:builder /home/builder/run_build.sh
chmod +x /home/builder/run_build.sh
echo ">>> [ROOT] Mengalihkan eksekusi ke user 'builder'..."

mkdir -p /iso
chmod 777 /iso
sudo -u builder bash /home/builder/run_build.sh

echo ">>> [ROOT] Membersihkan user dan sisa build..."
pkill -u builder || true
sleep 1
deluser --remove-home builder
rm -f /etc/sudoers.d/builder

echo ">>> [ROOT] Proses selesai."
